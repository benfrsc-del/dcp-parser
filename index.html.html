<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCP Parser - Advanced Text Extraction</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1rem;
            color: #666;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .config-section {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #1565c0;
            margin-bottom: 15px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .api-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .api-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #ddd;
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: scale(1.02);
        }

        .file-input-container {
            text-align: center;
            position: relative;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .file-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        .file-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .file-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b0b7;
        }

        .processing-section {
            display: none;
            background: #fff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .progress-container {
            margin-bottom: 25px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
        }

        .current-page {
            font-weight: 600;
            color: #333;
        }

        .processing-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.info {
            color: #0066cc;
        }

        .log-entry.success {
            color: #28a745;
        }

        .log-entry.warning {
            color: #ffc107;
        }

        .log-entry.error {
            color: #dc3545;
        }

        .results-section {
            display: none;
            background: #fff;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .qa-section {
            background: #fff8e1;
            border: 1px solid #ffcc02;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .qa-section h3 {
            color: #f57f17;
            margin-bottom: 15px;
        }

        .low-confidence-items {
            max-height: 200px;
            overflow-y: auto;
            background: #fafafa;
            border-radius: 8px;
            padding: 15px;
        }

        .confidence-item {
            background: white;
            border-left: 4px solid #ff9800;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 0 5px 5px 0;
            font-size: 0.9rem;
        }

        .confidence-score {
            font-weight: bold;
            color: #e65100;
        }

        .output-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            flex-wrap: wrap;
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 120px;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .output-content {
            display: none;
        }

        .output-content.active {
            display: block;
        }

        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .download-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .download-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .control-buttons {
            text-align: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            margin: 0 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .progress-details {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Advanced DCP Parser</h1>
            <p>Professional-grade Development Control Plan parser with coordinate-based text reconstruction, table detection, OCR fallback, and comprehensive rule extraction. Handles complex layouts, spaced capitals, and multi-column zone tables.</p>
        </div>

        <div class="config-section">
            <h3>Parser Configuration</h3>
            <div class="config-grid">
                <div>
                    <label>Y-Position Tolerance (px):</label>
                    <input type="number" id="yTolerance" class="config-input" value="3" min="1" max="10">
                </div>
                <div>
                    <label>Column Gap Threshold (px):</label>
                    <input type="number" id="columnGap" class="config-input" value="20" min="5" max="100">
                </div>
                <div>
                    <label>OCR Confidence Threshold:</label>
                    <input type="number" id="ocrThreshold" class="config-input" value="60" min="0" max="100">
                </div>
                <div>
                    <label>Min Rule Confidence:</label>
                    <input type="number" id="minConfidence" class="config-input" value="0.5" min="0" max="1" step="0.1">
                </div>
            </div>
        </div>

        <div class="api-section">
            <h3>OpenAI Integration (Optional)</h3>
            <input type="password" id="apiKey" class="api-input" placeholder="Enter your OpenAI API key (sk-...)">
            <div class="api-note">
                API key is used for generating vector embeddings from extracted rules and clean section summaries.
            </div>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="file-input-container">
                <input type="file" id="fileInput" class="file-input" accept=".pdf" multiple>
                <label for="fileInput" class="file-input-label">
                    Select DCP Files or Drag & Drop
                </label>
                <p style="margin-top: 15px; color: #666;">Supports PDF files with text and scanned images</p>
            </div>
            <div class="file-status" id="fileStatus"></div>
        </div>

        <div class="processing-section" id="processingSection">
            <h2>Processing Your Documents</h2>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-details">
                    <span class="current-page" id="currentPage">Initializing...</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>
            <div class="processing-log" id="processingLog"></div>
        </div>

        <div class="results-section" id="resultsSection">
            <h2>Parsing Results</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="statPages">0</div>
                    <div class="stat-label">Pages Processed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statRules">0</div>
                    <div class="stat-label">Development Rules</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statTables">0</div>
                    <div class="stat-label">Tables Detected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statZones">0</div>
                    <div class="stat-label">Zoning Areas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statConfidence">0</div>
                    <div class="stat-label">Avg Confidence</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statOCRPages">0</div>
                    <div class="stat-label">OCR Pages</div>
                </div>
            </div>

            <div class="qa-section" id="qaSection" style="display: none;">
                <h3>Quality Assurance - Low Confidence Items</h3>
                <div class="low-confidence-items" id="lowConfidenceItems"></div>
            </div>

            <div class="output-tabs">
                <button class="tab-button active" onclick="showTab('rules')">Extracted Rules</button>
                <button class="tab-button" onclick="showTab('json')">Full JSON</button>
                <button class="tab-button" onclick="showTab('summary')">Summary</button>
                <button class="tab-button" onclick="showTab('embeddings')">Vector Data</button>
            </div>

            <div class="output-content active" id="rulesOutput">
                <h3>Extracted Development Rules</h3>
                <div class="code-block" id="rulesCode"></div>
                <div class="download-buttons">
                    <button class="download-btn" onclick="downloadFile('rules')">Download Rules JSON</button>
                </div>
            </div>

            <div class="output-content" id="jsonOutput">
                <h3>Complete Structured JSON</h3>
                <div class="code-block" id="jsonCode"></div>
                <div class="download-buttons">
                    <button class="download-btn" onclick="downloadFile('json')">Download Full JSON</button>
                </div>
            </div>

            <div class="output-content" id="summaryOutput">
                <h3>Document Analysis Summary</h3>
                <div class="code-block" id="summaryCode"></div>
                <div class="download-buttons">
                    <button class="download-btn" onclick="downloadFile('summary')">Download Summary</button>
                </div>
            </div>

            <div class="output-content" id="embeddingsOutput">
                <h3>Vector Embeddings for AI/ML</h3>
                <div class="code-block" id="embeddingsCode"></div>
                <div class="download-buttons">
                    <button class="download-btn" onclick="downloadFile('embeddings')">Download Vectors</button>
                </div>
            </div>

            <div class="control-buttons">
                <button class="btn btn-primary" onclick="processAnotherFile()">Process Another File</button>
                <button class="btn btn-secondary" onclick="clearAll()">Clear All</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        let processedData = {};
        let processingCancelled = false;
        let parserConfig = {
            yTolerance: 3,
            columnGap: 20,
            ocrThreshold: 60,
            minConfidence: 0.5
        };

        // Configuration for planning controls
        const PLANNING_CONTROLS = {
            'landscaped_area': {
                patterns: [
                    /landscap(?:ed?|ing)\s*area/i,
                    /landscape\s*(?:provision|requirement)/i,
                    /soft\s*landscap/i
                ],
                units: ['%', 'percent', 'm²', 'sqm'],
                comparators: ['≥', '>=', 'minimum', 'min', 'at least']
            },
            'deep_soil': {
                patterns: [
                    /deep\s*soil/i,
                    /deep\s*soil\s*zone/i,
                    /deep\s*soil\s*area/i
                ],
                units: ['%', 'percent', 'm²', 'sqm'],
                comparators: ['≥', '>=', 'minimum', 'min', 'at least']
            },
            'site_coverage': {
                patterns: [
                    /site\s*coverage/i,
                    /building\s*coverage/i,
                    /lot\s*coverage/i,
                    /coverage\s*ratio/i
                ],
                units: ['%', 'percent'],
                comparators: ['≤', '<=', 'maximum', 'max', 'not exceed', 'no more than']
            },
            'building_height': {
                patterns: [
                    /building\s*height/i,
                    /maximum\s*height/i,
                    /height\s*limit/i,
                    /height\s*control/i
                ],
                units: ['m', 'metres', 'meters', 'storeys', 'storey', 'floors', 'floor'],
                comparators: ['≤', '<=', 'maximum', 'max', 'not exceed', 'no more than']
            },
            'fsr': {
                patterns: [
                    /floor\s*space\s*ratio/i,
                    /FSR/,
                    /gross\s*floor\s*area/i,
                    /GFA/
                ],
                units: [':1', 'ratio'],
                comparators: ['≤', '<=', 'maximum', 'max', 'not exceed']
            },
            'setbacks': {
                patterns: [
                    /(?:front|rear|side|boundary)\s*setback/i,
                    /building\s*separation/i,
                    /minimum\s*distance/i
                ],
                units: ['m', 'metres', 'meters'],
                comparators: ['≥', '>=', 'minimum', 'min', 'at least']
            },
            'private_open_space': {
                patterns: [
                    /private\s*open\s*space/i,
                    /POS/,
                    /outdoor\s*space/i,
                    /balcony\s*area/i
                ],
                units: ['m²', 'sqm', '%', 'percent'],
                comparators: ['≥', '>=', 'minimum', 'min', 'at least']
            },
            'parking': {
                patterns: [
                    /car\s*parking/i,
                    /vehicle\s*parking/i,
                    /parking\s*space/i,
                    /parking\s*requirement/i
                ],
                units: ['spaces', 'space', 'per dwelling', 'per unit'],
                comparators: ['≥', '>=', 'minimum', 'min', 'at least']
            }
        };

        const ZONE_PATTERNS = [
            /R[1-9][A-Z]?/g,  // R1, R2, R3A, etc.
            /B[1-9][A-Z]?/g,  // B1, B2, B3A, etc.
            /IN[1-9][A-Z]?/g, // IN1, IN2, etc.
            /E[1-9][A-Z]?/g,  // E1, E2, etc.
            /RE[1-9][A-Z]?/g, // RE1, RE2, etc.
            /RU[1-9][A-Z]?/g  // RU1, RU2, etc.
        ];

        // File input handling
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const fileStatus = document.getElementById('fileStatus');

        fileInput.addEventListener('change', handleFileSelect);
        uploadSection.addEventListener('dragover', handleDragOver);
        uploadSection.addEventListener('drop', handleDrop);
        uploadSection.addEventListener('dragleave', handleDragLeave);

        // Update config when inputs change
        document.getElementById('yTolerance').addEventListener('change', updateConfig);
        document.getElementById('columnGap').addEventListener('change', updateConfig);
        document.getElementById('ocrThreshold').addEventListener('change', updateConfig);
        document.getElementById('minConfidence').addEventListener('change', updateConfig);

        function updateConfig() {
            parserConfig = {
                yTolerance: parseInt(document.getElementById('yTolerance').value),
                columnGap: parseInt(document.getElementById('columnGap').value),
                ocrThreshold: parseInt(document.getElementById('ocrThreshold').value),
                minConfidence: parseFloat(document.getElementById('minConfidence').value)
            };
            logMessage('Parser configuration updated', 'info');
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            logMessage(`Files selected: ${files.length}`, 'info');
            
            if (files.length > 0) {
                const validFiles = files.filter(f => f.type === 'application/pdf');
                if (validFiles.length === 0) {
                    showFileStatus('Please select PDF files only', 'error');
                    return;
                }
                
                showFileStatus(`Selected ${validFiles.length} PDF file(s)`, 'success');
                processFiles(validFiles);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            uploadSection.classList.add('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = Array.from(event.dataTransfer.files).filter(f => f.type === 'application/pdf');
            
            if (files.length > 0) {
                showFileStatus(`Dropped ${files.length} PDF file(s)`, 'success');
                processFiles(files);
            } else {
                showFileStatus('Please drop PDF files only', 'error');
            }
        }

        function handleDragLeave(event) {
            uploadSection.classList.remove('dragover');
        }

        function showFileStatus(message, type) {
            fileStatus.textContent = message;
            fileStatus.className = `file-status ${type}`;
            fileStatus.style.display = 'block';
        }

        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            const processingLog = document.getElementById('processingLog');
            processingLog.appendChild(logEntry);
            processingLog.scrollTop = processingLog.scrollHeight;
        }

        function updateProgress(current, total, message) {
            const percentage = Math.round((current / total) * 100);
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('currentPage').textContent = message;
            document.getElementById('progressPercent').textContent = percentage + '%';
        }

        // Text normalization functions
        function normalizeText(text) {
            if (!text) return '';
            
            // Collapse spaced capitals: "L A N D S C A P E D" → "LANDSCAPED"
            text = text.replace(/([A-Z])\s+(?=[A-Z])/g, '$1');
            
            // Join hyphenated line breaks
            text = text.replace(/(\w+)-\s*\n\s*(\w+)/g, '$1$2');
            
            // Remove stray spaces in numerals and percentages
            text = text.replace(/(\d+)\s+(\.\s*\d+)/g, '$1$2');
            text = text.replace(/(\d+(?:\.\d+)?)\s*%/g, '$1%');
            text = text.replace(/(\d+(?:\.\d+)?)\s*(m²?|metres?|meters?|storeys?|floors?)/gi, '$1$2');
            
            // Standardize comparison operators
            text = text.replace(/≥|>=|at\s+least|minimum|min/gi, '≥');
            text = text.replace(/≤|<=|maximum|max|not\s+exceed|no\s+more\s+than/gi, '≤');
            
            // Standardize newlines
            text = text.replace(/\r\n|\r/g, '\n');
            
            return text.trim();
        }

        function reconstructLinesFromCoordinates(textItems) {
            if (!textItems || textItems.length === 0) return [];
            
            // Group items by y-position within tolerance
            const lineGroups = [];
            const sortedItems = [...textItems].sort((a, b) => b.transform[5] - a.transform[5]); // Sort by y (top to bottom)
            
            for (const item of sortedItems) {
                const y = item.transform[5];
                let foundGroup = false;
                
                for (const group of lineGroups) {
                    if (Math.abs(group.y - y) <= parserConfig.yTolerance) {
                        group.items.push(item);
                        foundGroup = true;
                        break;
                    }
                }
                
                if (!foundGroup) {
                    lineGroups.push({
                        y: y,
                        items: [item]
                    });
                }
            }
            
            // Sort items within each line by x-position (left to right)
            const reconstructedLines = lineGroups.map(group => {
                const sortedItems = group.items.sort((a, b) => a.transform[4] - b.transform[4]);
                const lineText = sortedItems.map(item => item.str).join(' ');
                
                return {
                    text: normalizeText(lineText),
                    y: group.y,
                    items: sortedItems,
                    xPositions: sortedItems.map(item => item.transform[4])
                };
            });
            
            return reconstructedLines.filter(line => line.text.trim().length > 0);
        }

        function detectTableStructure(lines) {
            const tables = [];
            let currentTable = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const isHeaderRow = detectHeaderRow(line.text);
                const columnCount = countColumns(line);
                
                if (isHeaderRow && columnCount > 1) {
